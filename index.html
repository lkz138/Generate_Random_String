<!DOCTYPE html>
<html lang="ja" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    <title>GetRandStr</title>
    <script type="text/javascript" src="https://apis.google.com/js/api.js"></script>
    <script type="text/javascript" src="https://www.google.com/recaptcha/api.js?render=6LfCHdcUAAAAAOwkHsW_7W7MfoOrvoIw9CXdLRBA"></script>
    <script type="text/javascript">
      function grecaptcha_init(token, act)
      {
        /*
        * Admin console url is 'https://www.google.com/recaptcha/admin'
        */

        grecaptcha.ready(function() {

          try {
            grecaptcha.reset(token, {action: act});
          } catch (e) {}

          try {
            grecaptcha.execute(token, {action: act}).then(function(token) {
              sessionStorage.setItem( (btoa(location.href)).slice(0, 16) + '.reCAPTCHA', token );
            });
          } catch (e) {}

        });
      }
    </script>
    <script type="text/javascript">
      grecaptcha_init('6LfCHdcUAAAAAOwkHsW_7W7MfoOrvoIw9CXdLRBA', 'homepage');
    </script>
    <!--==================================================-->
    <script type="text/javascript">
    function sendRequest()
    {
      $.ajax({
        url: './api/',
        type: 'GET',
        async: true,
        timeout: 5000,
        data: {
          len: sessionStorage.getItem('len'),
          chr: sessionStorage.getItem('chr'),
        }
      })
      .done(function(rawdata){
        console.log(rawdata);
        let arr=JSON.parse(sessionStorage.getItem('res'));
        arr.push(rawdata.detail);
        sessionStorage.setItem('res', JSON.stringify(arr));
      })
      .fail(function(rawdata){
        console.log(rawdata);
      })
      .always(function(){
        grecaptcha_init();
      });
    }
    function postProc()
    {
      let arr=JSON.parse(sessionStorage.getItem('res')); // current
      let hst=JSON.parse(sessionStorage.getItem('hst')); // history
      if (hst==null) {
        hst=arr;
      } else {
        hst=hst.concat(arr);
      }
      sessionStorage.setItem('hst', JSON.stringify(hst));

      $('div.print_r:last-child div').empty();
      arr.forEach(function(randstr){
        $('div.print_r:last-child').append('<div />');
        $('div.print_r:last-child div:last-child').append('<input />');
        $('div.print_r:last-child div:last-child input:last-child').attr('readonly', true);
        $('div.print_r:last-child div:last-child input:last-child').val(randstr);

        console.log(randstr);
        if (location.protocol=="https:") {
          try {
            var promise = navigator.clipboard.writeText(randstr);
            console.log(promise);
          } catch(e) {
            console.log(e);
          }
        }
      });
    }
    function sendSetup()
    {
      $('.print_r input').val('');
      sessionStorage.removeItem('res');
      sessionStorage.setItem('len', $('#len').val());
      sessionStorage.setItem('chr', $('#chr').val());
      sessionStorage.setItem('res', JSON.stringify([]));
      for (var i = 0; i < parseInt($('#cnt').val(), 10); i++) {
        sendRequest();
      }
      setTimeout(function () {
        postProc();
      }, 250);
    }
    </script>

    <script type="text/javascript">
      $(function(){

        $('#len_gui').change(function(){
          $('#len').val($(this).val());
        });

        $('#len').change(function(){
          $('#len_gui').val($(this).val());
        });

        $('#len_gui').mousemove(function(){
          $('#len_gui').change();
        });

        $('#cnt_gui').change(function(){
          $('#cnt').val($(this).val());
        });

        $('#cnt').change(function(){
          $('#cnt_gui').val($(this).val());
        });

        $('#cnt_gui').mousemove(function(){
          $('#cnt_gui').change();
        });

        $('#len, #len_gui').attr({
          min: 1,
          value: 8,
        });

        $('#cnt, #cnt_gui').attr({
          min: 1,
          max: 9,
          value: 1,
        });

        $('input.chr').click(function(){
          let chr=0;
          $('input.chr:checked').each(function(){
            chr+=parseInt($(this).val(), 10);
          });
          $('#chr').val(chr);
        });

        sendSetup();
        $('div.preference input[type=submit]').click(function(){ sendSetup(); });
        $(document).on('click', 'div.print_r input', function(){
          $(this).select();
        });

      });
    </script>

    <style media="screen">
      .grecaptcha-badge
      {
        display: none;
      }
      section#main
      {
        margin: 0 auto;
        width: 90%;
        max-width: 720px;
      }
      section#main div.preference, section#main div.print_r
      {
        background-color: azure;
        height: 200px;
        padding-right: 15px;
      }
      @media screen and (min-width: 320px) {
        section#main div.preference, section#main div.print_r
        {
          float: left;
        }
      }
      section#main div.print_r
      {
        background-color: honeydew;
      }
      section#main div.preference div
      {
        width: 85px;
      }
      section#main div.preference div input:not([type=checkbox])
      {
        width: 100%;
      }
      section#main div.print_r div
      {
        width: 185px;
      }
      section#main div.print_r div input
      {
        width: 100%;
        resize: both;
      }
    </style>
  </head>
  <body>
    <section id="main">
      <h3><script type="text/javascript">document.write(document.title);</script></h3>
      <div class="preference _len">
        <h4>Length</h4>
        <div><input type="range" id="len_gui"></div>
        <div><input type="number" id="len"></div>
      </div>
      <div class="preference _cnt">
        <h4>Loop</h4>
        <div><input type="range" id="cnt_gui"></div>
        <div><input type="number" id="cnt"></div>
      </div>
      <div class="preference _chr">
        <h4>Chars</h4>
        <div><input type="checkbox" class="chr" id="chr_1" value="2" checked><label for="chr_1">英小字</label></div>
        <div><input type="checkbox" class="chr" id="chr_2" value="1" checked><label for="chr_2">英大字</label></div>
        <div><input type="checkbox" class="chr" id="chr_3" value="8" checked><label for="chr_3">数字</label></div>
        <div><input type="checkbox" class="chr" id="chr_4" value="4" checked><label for="chr_4">記号</label></div>
        <div><input type="hidden" class="chr" id="chr" readonly></div>
      </div>
      <div class="preference _chr">
        <h4>Ctrl</h4>
        <div><input type="submit" value="再取得"></div>
      </div>
      <div class="print_r _res">
        <h4>Results</h4>
      </div>
    </section>
  </body>
</html>
